#############################################################################
#   Library:                Gentoo Network  
#   Application:            AutoGentoo
#   By:                     William Moore
#   Lib Version:            0.1
#   Copyright:              2015
#   License:                GPLv3   http://opensource.org/licenses/GPL-3.0
#############################################################################
# All functions and variables for mirrors and getting Gentoo Files


#Checks for the best mirrors for the user to use. This will also be stored and applied to the install for the fastest connections.
mirror_check() {
    case ${1} in
    switch)
        newmirrorlist="$(echo ${mirrorlist} | cut -d' ' -f2-) $(echo ${mirrorlist} | cut -d' ' -f1)"
        newmirror="$(echo ${mirrorlist} | cut -d' ' -f1)"
        
        sed -i '\!^export mirrorlist=!d' ${vl}
        sed -i '\!^export mirror=!d' ${vl}
        
        a2v "mirrorlist=\"${newmirrorlist}\""
        a2v "mirror=\"${newmirror}\""
    ;;
    *)
        if [ -e "connected.eg" ]; then
            stat_file="download_times.eg"
            test_file="CX2.zip"
            #~ test_file="amarachthemepack.zip"
            test_file_target="distfiles/${test_file}"
            
            rm -rf ${test_file}
            touch ${stat_file}
            
            eb2 "* "; eg "Testing Gentoo mirrors..."; sleep 0.5s
            
            #mirrorlist="http://gentoo.mirrors.tera-byte.com/ http://ftp.ucsb.edu/pub/mirrors/linux/gentoo/ http://mirrors.rit.edu/gentoo/"
            #mirrorlist="${mirrorlist} http://gentoo.localhost.net.ar/ http://www.las.ic.unicamp.br/pub/gentoo/ http://gd.tuwien.ac.at/opsys/linux/gentoo/"
            #mirrorlist="${mirrorlist} http://mirrors.telepoint.bg/gentoo/ http://gentoo.mirror.web4u.cz/ http://gentoo.wheel.sk/"
            #mirrorlist="${mirrorlist} http://ftp-stud.hs-esslingen.de/pub/Mirrors/gentoo/ http://mirrors.xservers.ro/gentoo/"
            #mirrorlist="${mirrorlist} http://gentoo-euetib.upc.es/mirror/gentoo/ http://ftp.df.lth.se/pub/gentoo/ http://gentoo.kiev.ua/ftp/"
            #mirrorlist="${mirrorlist} http://mirrors.stuhome.net/gentoo/ ftp://mirrors.linuxant.fr/distfiles.gentoo.org"
            #mirrorlist="${mirrorlist} http://gentoo.bloodhost.ru/ http://ftp.kaist.ac.kr/gentoo/ http://mirror.isoc.org.il/pub/gentoo/"
            #mirrorlist="${mirrorlist} http://files.gentoo.gr/ http://gentoo.prz.rzeszow.pl/ http://ftp.dei.uc.pt/pub/linux/gentoo/"
            #US Lists
            mirrorlist="http://mirror.usu.edu/mirrors/gentoo/ http://seal.cs.uni.edu/ http://gentoo.cites.uiuc.edu/pub/gentoo/"
            mirrorlist="${mirrorlist} http://mirror.lug.udel.edu/pub/gentoo/ http://ftp.ucsb.edu/pub/mirrors/linux/gentoo/"
            mirrorlist="${mirrorlist} http://gentoo.mirrors.tds.net/gentoo/ http://gentoo.llarian.net/ http://mirror.iawnet.sandia.gov/gentoo/"
            mirrorlist="${mirrorlist} http://mirrors.rit.edu/gentoo/ http://gentoo.mirrors.pair.com/ http://gentoo.osuosl.org/ http://gentoo.netnitco.net/"
            mirrorlist="${mirrorlist} http://lug.mtu.edu/gentoo/ http://gentoo.mirrors.hoobly.com/ http://www.gtlib.gatech.edu/pub/gentoo/"
            mirrorlist="${mirrorlist} http://gentoo.mirrors.easynews.com/linux/gentoo/"
            
            mno="1"
            for mrr in ${mirrorlist}
            do
                (( mno < 10 )) && { er2 "      ${mno}- "; eb "${mrr}"; } || { er2 "     ${mno}- "; eb "${mrr}"; }
                
                read info1 info2 <<< "$( { time -p download2 ${mrr}${test_file_target}; } 2>&1 | grep real )"
                [[ -e "download.done" ]] && echo "${info2} ${mrr}" >> ${stat_file}
                
                rm -rf ${test_file}
                
                ((mno++))
            done
            unset mno
            
            echo; ey "  Choosing 5 fastest mirrors..."; sleep 0.5s
        
            while read info3 info4
            do
                if [ -n "${info4}" ]; then
                    if [ -z "${fastest_mirrors}" ]; then
                        fastest_mirrors="${info4}"
                        first_mirror="${info4}"
                    else
                        fastest_mirrors="${fastest_mirrors} ${info4}"
                    fi
                fi
            done <<< "$(sort -n ${stat_file} | sed 5q)"
            
            sed -i '\!^export mirrorlist=!d' ${vl}
            sed -i '\!^export mirror=!d' ${vl}
            sed -i '\!^export ping_target=!d' ${vl}
            
            a2v "mirrorlist=\"${fastest_mirrors}\""
            a2v "mirror=\"${first_mirror}\""
            # Trimming mirror name. Ex. http://gentoo.kiev.ua/ftp -->> gentoo.kiev.ua
            a2v "ping_target=\"$(echo ${mirror} | sed -e 's/.*\:\/\///' -e 's/\/.*$//')\""
        fi
    ;;
    esac
    
    case ${arch} in
    i686)
        tarballurl="${mirror}releases/x86/autobuilds"
    ;;
    amd64)
        tarballurl="${mirror}releases/amd64/autobuilds"
    ;;
    esac
    
    snapshoturl="${mirror}snapshots"
}